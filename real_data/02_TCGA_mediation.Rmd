---
title: "survival analysis with deconvolution exposition"
output: html_document
date: "2025-01-27"
---

# TCGA data

```{r load}
library(survival)
library(ggplot2)
library(see)
library(dplyr)
library(UpSetR)

tcga_data = readRDS("results/01_tcga_data_expo_deconv.rds")

# define variables
time = tcga_data$time
status = tcga_data$status
age = tcga_data$age
gender = tcga_data$gender
grade = tcga_data$grade
X_deconv = tcga_data$X_deconv$Consensus
M = tcga_data$M
tobacco_bin = tcga_data$tobacco_bin
alcohol = tcga_data$alcohol

# keep only immune cells
immune_cells = c("Neutrophils","Macrophages","B cells", "T cells", "NK","DCs")
X_immune = X_deconv[rownames(X_deconv) %in% immune_cells,]
```

# Survival analysis with Cox, parametric and Aalen models

```{r survival_analysis, echo=F}
base = survival::Surv(time, status)
plot(survival::survfit(base~1), conf.int=T, mark.time = F, main = "Overall survival")

#########################################
# survival analysis with cox model
mod_cox = survival::coxph(formula(
  paste0("base ~",
         paste("X_immune[", 1:nrow(X_immune), ",]",sep = "", collapse = "+"),
         "+ age + gender + grade")))
summary(mod_cox)
# X_immune[5, ]  5.918e+01  5.047e+25  3.519e+01  1.682   0.0926 .


#########################################
# survival analysis with survreg (parametric model)
distributions <- c("weibull", "exponential", "gaussian", "logistic", "lognormal", "loglogistic")
aic_values <- list()
valid_distributions <- rep(FALSE, length(distributions))
for (i in seq_along(distributions)) {
  # Adjust the model w/ each distribution
  fit <- tryCatch({
      survival::survreg(formula(paste0("base ~",
                                 paste("X_immune[", 1:nrow(X_immune), ",]",
                                       sep = "", collapse = "+"),
                                 "+ age + gender + grade")),
                        dist = distributions[i])}, error = function(e) {
      NULL})
  # Check model validity
  if (!is.null(fit)) {
    valid_distributions[i] <- TRUE
    # AIC
    aic_values[[i]] <- -2 * as.numeric(logLik(fit)) + 2 * length(coef(fit))
  } else {
    aic_values[[i]] <- Inf # infinite AIC for invalid distributions
  }
}
names(aic_values) = distributions
if (all(!valid_distributions)) {
  stop("No valid distribution")
}

# Identify the best distribution with AIC
aic_values = aic_values[valid_distributions]
best_distribution = names(which.min(aic_values))

# Adjust model with the best distribution
mod_param <- survival::survreg(formula(paste0("base ~",
                                 paste("X_immune[", 1:nrow(X_immune), ",]",
                                       sep = "", collapse = "+"),
                                 "+ age + gender + grade")),
                    dist = best_distribution)
summary(mod_param)
# X_immune[5, ] -2.72e+04   1.30e+04 -2.09   0.037


#########################################
# survival analysis with aalen model
mod_aalen = timereg::aalen(formula(paste0("base ~",
                                paste("X_immune[", 1:nrow(X_immune), ",]",
                                       sep = "", collapse = "+"),
                                "+ age + gender + grade")))
mod_aalen$pval.testBeq0[2:(length(mod_aalen$pval.testBeq0)-2)] # nothing
```

Some deconvolution estimates have an effect on survival.
Aalen method does not yield anything.

# Plot Fig 4

```{r fig4}
df_cox = data.frame(CellType=rownames(X_immune),
                    Algorithm="Consensus",
                    Pval=summary(mod_cox)$coef[1:(length(mod_cox$coef)-3),5],
                    Effect=mod_cox$coef[1:(length(mod_cox$coef)-3)])
df_param = data.frame(CellType=rownames(X_immune),
                    Algorithm="Consensus",
                    Pval=summary(mod_param)$table[2:(length(mod_param$coef)-3),4],
                    Effect=mod_param$coef[2:(length(mod_param$coef)-3)])

df_cox$`-log10(pval)` = -log10(df_cox$Pval)
df_param$`-log10(pval)` = -log10(df_param$Pval)
df_cox$CellType[df_cox$CellType=='DCs'] = 'all DCs'
df_param$CellType[df_param$CellType=='DCs'] = 'all DCs'
df_cox$CellType[df_cox$CellType=='T cells'] = 'all T cells'
df_param$CellType[df_param$CellType=='T cells'] = 'all T cells'
#df_cox$CellType = factor(df_cox$CellType, levels=c("Macrophages", "Neutrophils","NK",
#                                                   "B cells",
#                                                   "all T cells","all DCs"))

ggplot(df_cox, aes(x=CellType, y=Algorithm, size=Effect, color=`-log10(pval)`)) +
    geom_point() +
    scale_color_viridis_c(option='plasma') +
    theme_modern(axis.text.angle = 30)
ggplot(df_param, aes(x=CellType, y=Algorithm, size=Effect, color=`-log10(pval)`)) +
    geom_point() +
    scale_color_viridis_c(option='plasma') +
    theme_modern(axis.text.angle = 30)
```

# Stratification based on all consensus deconvolution outputs

```{r consensus_stratification fig4}
strat = lapply(rownames(X_immune), function(type)
  cut(X_immune[type,], breaks=2, labels=F))
names(strat) = rownames(X_immune)

# Make df
df_strat_consensus = data.frame(time = time,
                      status = status,
                      strat_Neutro = strat$Neutrophils,
                      strat_Macro = strat$Macrophages,
                      strat_Bcell = strat$`B cells`,
                      strat_Tcell = strat$`T cells`,
                      strat_NK = strat$NK,
                      strat_DC = strat$DCs)

# Kaplan Meier curves
survminer::ggsurvplot(survfit(base~strat_Neutro, data=df_strat_consensus),
                      data=df_strat_consensus,pval=T)
survminer::ggsurvplot(survfit(base~strat_Macro, data=df_strat_consensus),
                      data=df_strat_consensus,pval=T)
survminer::ggsurvplot(survfit(base~strat_Bcell, data=df_strat_consensus),
                      data=df_strat_consensus,pval=T)
survminer::ggsurvplot(survfit(base~strat_Tcell, data=df_strat_consensus),
                      data=df_strat_consensus,pval=T)
survminer::ggsurvplot(survfit(base~strat_NK, data=df_strat_consensus),
                      data=df_strat_consensus,pval=T)
survminer::ggsurvplot(survfit(base~strat_DC, data=df_strat_consensus),
                      data=df_strat_consensus,pval=T)
```
The best stratification is based on NKs, as predicted by Cox and parametric models

# Stratification based on risk factors

```{r riskfactor_stratification fig4}
# Make df
df_strat_risks = data.frame(time = time,
                              status = status,
                              smoker = tobacco_bin,
                              alcohol = alcohol)

# Kaplan Meier curves
survminer::ggsurvplot(survfit(base~smoker, data=df_strat_risks),
                      data=df_strat_risks,pval=T)
survminer::ggsurvplot(survfit(base~alcohol, data=df_strat_risks),
                      data=df_strat_risks,pval=T)

base = survival::Surv(time, status)
plot(survival::survfit(base~1), conf.int=T, mark.time = F, main = "Overall survival")

#########################################
# survival analysis with cox model
summary(survival::coxph(base ~ tobacco_bin + age + gender + grade))
summary(survival::coxph(base ~ tobacco_bin + age + gender))
```

# Mediation analysis

## Tobacco -> DNAm



```{r mediation tobacco_dnam_survival with imm cells LF estimation integration K = 8}
source("surv_parametric_alternative.R")

exposure = tobacco_bin
survival_time = as.vector(time)
censoring_status = as.vector(status)
#M = as.matrix(M_sample_13)
M_met = as.matrix(M)
K = 8
immune_cells = t(X_immune[-1,])

covar_U = as.matrix(cbind(exposure, immune_cells,tcga_data$grade, tcga_data$age,tcga_data$gender))
covar = as.matrix(cbind(tcga_data$grade, tcga_data$age,tcga_data$gender))
######################
# mediation with parametric model (survreg function)
######################
hdmax2_step1_param = run_AS_surv_param_alter(exposure, survival_time, censoring_status, covar_U = covar_U, covar= covar, M_met, K = K)
m_param = M_met[, names(sort(hdmax2_step1_param$max2_pvalues))[1:10]]
hdmax2_step2_param = estimate_effect_surv_param(hdmax2_step1_param, m = m_param)
hdmax2_param_tobacco_dnam = list(hdmax2_step1_param=hdmax2_step1_param,
                                 m_param=m_param,
                                 hdmax2_step2_param=hdmax2_step2_param)
saveRDS(hdmax2_param_tobacco_dnam, "results/02_tcga_med_tobacco_dnam_V2_K8_corrected.rds")
# temp = readRDS("results/02_tcga_med_tobacco_dnam_V2_K8_corrected.rds")
# saveRDS(temp, "results/02_tcga_med_tobacco_dnam_V2_K8_corrected.rds")
```


```{r aalen mediation tobacco_dnam_survival with imm cells LF estimation integration K = 8, eval=F}
############# with aalen's survival model
source("surv_aalen_alternative.R")

exposure = tobacco_bin
survival_time = as.vector(time)
censoring_status = as.vector(status)
#M = as.matrix(M_sample_13)
M_met = as.matrix(M)
K = 8
immune_cells = t(X_immune[-1,])

env = as.matrix(cbind(exposure, immune_cells,tcga_data$grade, tcga_data$age,tcga_data$gender))
covar = as.matrix(cbind(tcga_data$grade, tcga_data$age,tcga_data$gender))
######################
# mediation with parametric model (survreg function)
######################
hdmax2_step1_aalen = run_AS_surv_aalen(exposure, survival_time, censoring_status, covar_U = env, covar= covar, M_met, K = K)
m_aalen = M_met[, names(sort(hdmax2_step1_aalen$max2_pvalues))[1:10]]
hdmax2_step2_aalen = estimate_effect_surv_aalen(hdmax2_step1_param, m = m_param)
hdmax2_aalen_tobacco_dnam = list(hdmax2_step1_aalen=hdmax2_step1_aalen,
                                 m_aalen=m_aalen,
                                 hdmax2_step2_aalen=hdmax2_step2_aalen)
saveRDS(hdmax2_aalen_tobacco_dnam, "results/02_tcga_med_tobacco_dnam_aalen_V2_K8.rds")
# temp = readRDS("results/02_tcga_med_tobacco_dnam_aalen_V2_K8.rds")
# saveRDS(temp, "results/02_tcga_med_tobacco_dnam_aalen_V2_K8.rds")

```


```{r hima mediation tobacco_dnam_survival }
############# with aalen's survival model
source("HIMA_last_version.R")
library(glmnet)

exposure = tobacco_bin
survival_time = as.vector(time)
censoring_status = as.vector(status)
#M = as.matrix(M_sample_13)
M_met = as.matrix(M)
dim(M_met)

#369969

#immune_cells = t(X_immune[-1,])

#env = as.matrix(cbind(exposure, immune_cells,tcga_data$grade, tcga_data$age,tcga_data$gender))
covar = as.matrix(cbind(tcga_data$grade, tcga_data$age,tcga_data$gender))
######################
# mediation with parametric model (survreg function)
######################
hdmax2_step1_hima_alter = hima_survival_alter(exposure, M_met, survival_time, censoring_status, COV= covar,   FDRcut = 1, topN = 100, verbose = TRUE)

m_hima = M_met[, hdmax2_step1_hima_alter$out_result$Index]

hdmax2_hima_tobacco_dnam = list(hdmax2_step1_hima = hdmax2_step1_hima_alter,
                                 m_hima = m_hima)
saveRDS(hdmax2_hima_tobacco_dnam, "results/02_tcga_med_tobacco_dnam_hima.rds")
# temp = readRDS("results/02_tcga_med_tobacco_dnam_aalen_V2_K8.rds")
# saveRDS(temp, "results/02_tcga_med_tobacco_dnam_aalen_V2_K8.rds")



```



HIMA_last_version.R

## BRAC mediation

```{r}
clin_brca = read.delim("~/Datas/projects/datashare/TCGA_BRCA/clinical.project-tcga-brca.2025-05-01/clinical.tsv")

expo_brca = read.delim("~/Datas/projects/datashare/TCGA_BRCA/clinical.project-tcga-brca.2025-05-01/exposure.tsv")
follow_up_brca = read.delim("~/Datas/projects/datashare/TCGA_BRCA/clinical.project-tcga-brca.2025-05-01/follow_up.tsv")


```

## Immune consensus -> DNAm

```{r mediation consensus_dnam_survival, eval=F}
source("surv_parametric.R")

exposure = data.frame(t(X_immune$Consensus))[,-c(1)] # remove 0 neutrophils
survival_time = as.vector(time)
censoring_status = as.vector(status)
M_met = as.matrix(M)
K = 5

######################
# mediation with parametric model (survreg function)
######################
hdmax2_step1_param = run_AS_surv_param(exposure, survival_time, censoring_status,
                   M_met, K, covar = cbind(tcga_data$age,
                                           tcga_data$gender,
                                           tcga_data$grade), suppl_covar = NULL, each_var_pval = FALSE)
m_param = M[, names(sort(hdmax2_step1_param$max2_pvalues))[1:10]]
hdmax2_step2_param = estimate_effect_surv_param(hdmax2_step1_param, m = m_param)
hdmax2_param_imm_dnam_multi = list(hdmax2_step1_param=hdmax2_step1_param,
                             m_param=m_param,
                             hdmax2_step2_param=hdmax2_step2_param)
saveRDS(hdmax2_param_imm_dnam_multi, "results/02_tcga_med_immconsens_dnam_multi.rds")
```

# ANOVA tobacco > Immune consensus

```{r}
anova = apply(X_immune, 1, function(x) aov(x ~ tobacco_bin))
lapply(anova, summary) # all p-values are way above 10%

df_immune_tobacco = data.frame(Tobacco = tobacco_bin,
                               Immconsens_neutro = X_immune["Neutrophils",],
                               Immconsens_macro = X_immune["Macrophages",],
                               Immconsens_Bcell = X_immune["B cells",],
                               Immconsens_Tcell = X_immune["T cells",],
                               Immconsens_NK = X_immune["NK",],
                               Immconsens_DC = X_immune["DCs",])
df_immune_tobacco$Tobacco = ifelse(df_immune_tobacco$Tobacco==0,"Non smoker","Smoker")

ggplot(df_immune_tobacco, aes(x=Tobacco, y=Immconsens_neutro)) +
  geom_violin(aes(fill=Tobacco)) +
  geom_point() +
  theme_modern()
ggplot(df_immune_tobacco, aes(x=Tobacco, y=Immconsens_macro)) +
  geom_violin(aes(fill=Tobacco)) +
  geom_point() +
  theme_modern()
ggplot(df_immune_tobacco, aes(x=Tobacco, y=Immconsens_Bcell)) +
  geom_violin(aes(fill=Tobacco)) +
  geom_point() +
  theme_modern()
ggplot(df_immune_tobacco, aes(x=Tobacco, y=Immconsens_Tcell)) +
  geom_violin(aes(fill=Tobacco)) +
  geom_point() +
  theme_modern()
ggplot(df_immune_tobacco, aes(x=Tobacco, y=Immconsens_NK)) +
  geom_violin(aes(fill=Tobacco)) +
  geom_point() +
  theme_modern()
ggplot(df_immune_tobacco, aes(x=Tobacco, y=Immconsens_DC)) +
  geom_violin(aes(fill=Tobacco)) +
  geom_point() +
  theme_modern()
```

# Plots

## ACME

```{r visualisation_ACME}
hdmax2_tobacco_dnam          = readRDS("results/02_tcga_med_tobacco_dnam.rds")
hdmax2_immconsens_dnam_multi = readRDS("results/02_tcga_med_immconsens_dnam_multi.rds")

ggplot(hdmax2_tobacco_dnam$hdmax2_step2_param$effects$univariate$ACME, aes(y=feat, x=est, xmin=CI_2.5, xmax=CI_97.5)) +
  geom_point(color = 3) + 
  geom_errorbarh(height=.1, color = 3) +
  labs(title='ACME (Tobacco > DNAm)', x='Effect Size', y = 'Probes') +
  geom_vline(xintercept=0, color='black', linetype='dashed', alpha=1) +
  theme_minimal()

ggplot(hdmax2_immconsens_dnam_multi$hdmax2_step2_param$effects$Macrophages$ACME, aes(y=feat, x=est, xmin=CI_2.5, xmax=CI_97.5)) +
  geom_point(color = 3) + 
  geom_errorbarh(height=.1, color = 3) +
  labs(title='ACME (Consensus Macrophages > DNAm)', x='Effect Size', y = 'Probes') +
  geom_vline(xintercept=0, color='black', linetype='dashed', alpha=1) +
  theme_minimal()
ggplot(hdmax2_immconsens_dnam_multi$hdmax2_step2_param$effects$B.cells$ACME, aes(y=feat, x=est, xmin=CI_2.5, xmax=CI_97.5)) +
  geom_point(color = 3) + 
  geom_errorbarh(height=.1, color = 3) +
  labs(title='ACME (Consensus B cells > DNAm)', x='Effect Size', y = 'Probes') +
  geom_vline(xintercept=0, color='black', linetype='dashed', alpha=1) +
  theme_minimal()
ggplot(hdmax2_immconsens_dnam_multi$hdmax2_step2_param$effects$T.cells$ACME, aes(y=feat, x=est, xmin=CI_2.5, xmax=CI_97.5)) +
  geom_point(color = 3) + 
  geom_errorbarh(height=.1, color = 3) +
  labs(title='ACME (Consensus T cells > DNAm)', x='Effect Size', y = 'Probes') +
  geom_vline(xintercept=0, color='black', linetype='dashed', alpha=1) +
  theme_minimal()
ggplot(hdmax2_immconsens_dnam_multi$hdmax2_step2_param$effects$NK$ACME, aes(y=feat, x=est, xmin=CI_2.5, xmax=CI_97.5)) +
  geom_point(color = 3) + 
  geom_errorbarh(height=.1, color = 3) +
  labs(title='ACME (Consensus NKs > DNAm)', x='Effect Size', y = 'Probes') +
  geom_vline(xintercept=0, color='black', linetype='dashed', alpha=1) +
  theme_minimal()
ggplot(hdmax2_immconsens_dnam_multi$hdmax2_step2_param$effects$DCs$ACME, aes(y=feat, x=est, xmin=CI_2.5, xmax=CI_97.5)) +
  geom_point(color = 3) + 
  geom_errorbarh(height=.1, color = 3) +
  labs(title='ACME (Consensus DCs > DNAm)', x='Effect Size', y = 'Probes') +
  geom_vline(xintercept=0, color='black', linetype='dashed', alpha=1) +
  theme_minimal()
```

## All effects

```{r visualisation_effects}
df_tobacco_dnam = data.frame(Effect_value = unlist(lapply(hdmax2_tobacco_dnam$hdmax2_step2_param$effects$univariate[1:4], function(x) x$est)),
                             Effect_type = unlist(lapply(seq_along(hdmax2_tobacco_dnam$hdmax2_step2_param$effects$univariate[1:4]), function(x) rep(names(hdmax2_tobacco_dnam$hdmax2_step2_param$effects$univariate)[x],nrow(hdmax2_tobacco_dnam$hdmax2_step2_param$effects$univariate[[x]])))))

df_immconsens_dnam = data.frame(Effect_value = unlist(lapply(hdmax2_immconsens_dnam_multi$hdmax2_step2_param$effects, function(x)
  unlist(lapply(x[1:4], function(y) y$est)))),
      Effect_type = unlist(lapply(hdmax2_immconsens_dnam_multi$hdmax2_step2_param$effects, function(x)
  unlist(lapply(seq_along(x[1:4]), function(y) rep(names(x)[y],nrow(x[[y]])))))),
      Exposition = unlist(lapply(names(hdmax2_immconsens_dnam_multi$hdmax2_step2_param$effects), function(x) rep(x, ncol(hdmax2_immconsens_dnam_multi$m_param)*4))))

df_tobacco_dnam$Effect_type = factor(df_tobacco_dnam$Effect_type, levels = c("ACME","TE","ADE"))

source("hdmax2_plot.R")

plot_hdmax2(hdmax2_tobacco_dnam$hdmax2_step2_param, plot_type = "all_plot")
plot_hdmax2(hdmax2_immconsens_dnam_multi$hdmax2_step2_param, plot_type = "all_plot")
```

## Upset plots

Common mediator probes between the mediations "Tobacco > DNAm" and "Immune content > DNAm" (consensus or not)

```{r visualisation_upset}
n_probes=100
upset_tobacco_dnam = names(sort(hdmax2_tobacco_dnam$hdmax2_step1_param$max2_pvalues))[1:n_probes]
upset_immconsens_dnam = names(sort(hdmax2_immconsens_dnam_multi$hdmax2_step1_param$max2_pvalues))[1:n_probes]

upset_input <- list(tobacco_dnam = upset_tobacco_dnam,
                    immconsens_dnam = upset_immconsens_dnam)
upset(fromList(upset_input), order.by = "freq")
```
